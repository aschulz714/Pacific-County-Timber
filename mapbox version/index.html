<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>Pacific County Timber</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <!-- Is the is the latest version of Leaflet? -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">

  <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css' rel='stylesheet' />

  <style>
    body {
      margin: 0;
      padding: 0;
      background: rgb(42, 42, 42);
      font-family: "Lato", sans-serif;
      font-size: 100%;
      font-weight: 300;
      color: rgb(172, 172, 172);
    }

    header,
    footer,
    section {
      padding: 6px 10%;
      margin: 0 auto;
      width: 80%
    }

    h1 {
      display: inline-block;
      margin-right: 20px;
      color: rgb(190, 190, 190);
      font-size: 3.5em;
      font-weight: 700;
    }

    h2 {
      display: inline-block;
      color: #139925;
      letter-spacing: 0.05em;
      margin-top: 0px;
      font-weight: 300;
      text-transform: uppercase;
      /*  Stack text shadows.  */
      text-shadow: 0 0 30px #067018, 0 0 40px #067018, 0 0 50px #067018, 0 0 80px #067018;
    }


    #map {
      width: 80%;
      height: 540px;
      margin: 10px auto;
    }


    p {
      font-size: 1em;
      color: rgba(170, 170, 170);
      ;
      font-weight: 300;
      font-size: 1.2em;
    }
  </style>
</head>

<body>
  <header>
    <h1>Pacific County, Washington</h1>
    <h2>Designated Forest Land Parcels</h2>
  </header>

  <div id='map'></div>

  <footer>
    <p>Map authored by Alex Schulz</p>
    <p>Additional information about the data and map goes here.</p>
  </footer>
  <!-- Is the is the latest version of Leaflet? -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js'></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <script>
    let countiesGeoJson

    fetch("../d3/data/pacific_county.json")
      .then(response => {
        if (response.ok) {
          return response.json()
        } else {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      })
      .then(data => {
        countiesGeoJson = topojson.feature(data, {
          type: 'GeometryCollection',
          geometries: data.objects.pacific_county.geometries
        });
      })





    var map = L.map('map', {
      center: [36, -94],
      zoom: 4,
    });

    mapboxgl.accessToken =
      'pk.eyJ1IjoiYXNjaHVsejcxNCIsImEiOiJja2k4ZHNoZmQwNHRsMnlvNDZ0bjhqcGlwIn0.cPldI_1d7yJe5f9mm8rBwA';
    var map = new mapboxgl.Map({
      container: 'map', // container ID
      style: 'mapbox://styles/aschulz714/ckimcu8ei1epf17obf5h9u64j', // style URL
      center: [-123.7179352, 46.5664905], // starting position [lng, lat]
      zoom: 9 // starting zoom
    });


    // var commonStyles = {
    //   weight: 1,
    //   stroke: 1,
    //   fillOpacity: .8
    // }

    // var countyLayer = $.getJSON('data/pacific_county.json', function (data) {
    //   console.log(data);
    //   var dataLayer = L.geoJson(data, {
    //     style: function (feature) {
    //       return {
    //         color: '#dddddd',
    //         weight: 1,
    //         fillOpacity: 1,
    //         fillColor: '#1f78b4'
    //       }
    //     }

    //   }).addTo(map);


    // });

    map.on('load', function () {
      map.addSource('parcels', {
        'type': 'geojson',
        'data': countiesGeoJson
      });

      // The feature-state dependent fill-opacity expression will render the hover effect
      // when a feature's hover state is set to true.
      map.addLayer({
        'id': 'state-fills',
        'type': 'fill',
        'source': 'parcels',
        'layout': {},
        'paint': {
          'fill-color': '#627BC1',
          'fill-opacity': [
            'case',
            ['boolean', ['feature-state', 'hover'], false],
            1,
            0.4
          ]
        }
      });


      map.addLayer({
        'id': 'state-borders',
        'type': 'line',
        'source': 'parcels',
        'layout': {},
        'paint': {
          'line-color': '#627BC1',
          'line-width': 2
        }
      });

      // Create a popup, but don't add it to the map yet.
      // var popup = new mapboxgl.Popup({
      // closeButton: false,
      // closeOnClick: false
      // });

      // map.on('mouseenter', 'state-fills', function (e) {
      // // Change the cursor style as a UI indicator.
      // map.getCanvas().style.cursor = 'pointer';

      // var coordinates = e.features[0].geometry.coordinates.slice();
      // var description = `${e.features[0].properties.CURRENT_O} </BR>
      //  Acres: ${e.features[0].properties.ACRES.toFixed()} </BR>
      //  Assessed Value: $ ${e.features[0].properties.ASSESSED.toLocaleString()}`;

      // // Ensure that if the map is zoomed out such that multiple
      // // copies of the feature are visible, the popup appears
      // // over the copy being pointed to.
      // while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
      // coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      // }

      // // Populate the popup and set its coordinates
      // // based on the feature found.
      // popup.setLngLat(coordinates).setHTML(description).addTo(map);
      // });

      // map.on('mouseleave', 'state-fills', function () {
      // map.getCanvas().style.cursor = '';
      // popup.remove();
      // });

      var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
      });

      map.on('mouseenter', 'state-fills', function (e) {
        map.getCanvas().style.cursor = 'pointer';

        var coordinates = e.features[0].geometry.coordinates.slice();

        // while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        // coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;

        // }

        popup.setLngLat(e.lngLat).setHTML(`${e.features[0].properties.CURRENT_O} </BR>
            Acres: ${e.features[0].properties.ACRES.toFixed()} </BR>
            Assessed Value: $ ${e.features[0].properties.ASSESSED.toLocaleString()}`).addTo(map);
     
     
      // map.on('mouseenter', 'state-fills', function (e) {
      //   new mapboxgl.Popup()
      //     .setLngLat(e.lngLat)
      //     .setHTML(`${e.features[0].properties.CURRENT_O} </BR>
      //       Acres: ${e.features[0].properties.ACRES.toFixed()} </BR>
      //       Assessed Value: $ ${e.features[0].properties.ASSESSED.toLocaleString()}`)
      //     .addTo(map);


      // });

      map.on('mouseleave', 'state-fills', function () {
        map.getCanvas().style.cursor = '';
        popup.remove();
      });


      //     map.on('mouseenter', 'state-fills', function () {
      // map.getCanvas().style.cursor = 'pointer';
      // });

      // // Change it back to a pointer when it leaves.
      // map.on('mouseleave', 'state-fills', function () {
      // map.getCanvas().style.cursor = '';
      // });

    });

  })
  </script>

</body>

</html>